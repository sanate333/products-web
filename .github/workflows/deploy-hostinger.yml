name: Deploy Hostinger

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm install --include=dev --no-audit --no-fund

      - name: Ensure react-scripts
        run: npm install react-scripts@5.0.1 --no-save --no-audit --no-fund

      - name: Build React app
        id: build_react
        continue-on-error: true
        shell: pwsh
        run: |
          $env:CI = "false"
          npx react-scripts build 2>&1 | Tee-Object -FilePath build-log.txt
          if ($LASTEXITCODE -ne 0) {
            "BUILD_FAILED=1" | Out-File -FilePath $env:GITHUB_ENV -Append
          }

      - name: Report build failure
        if: env.BUILD_FAILED == '1'
        shell: pwsh
        run: |
          $tail = (Get-Content -Path build-log.txt -Tail 80) -join "`n"
          $tail = $tail -replace "`r",""
          $tail = $tail -replace "%","%25" -replace "`n","%0A" -replace "`r","%0D"
          Write-Output "::error title=React build failed::$tail"
          exit 1

      - name: Sync public_html
        run: node post-build.js

      - name: Preflight FTP connection
        shell: pwsh
        run: |
          if ([string]::IsNullOrWhiteSpace("${{ secrets.HOSTINGER_FTP_SERVER }}")) { throw "Missing secret: HOSTINGER_FTP_SERVER" }
          if ([string]::IsNullOrWhiteSpace("${{ secrets.HOSTINGER_FTP_USERNAME }}")) { throw "Missing secret: HOSTINGER_FTP_USERNAME" }
          if ([string]::IsNullOrWhiteSpace("${{ secrets.HOSTINGER_FTP_PASSWORD }}")) { throw "Missing secret: HOSTINGER_FTP_PASSWORD" }
          $server = "${{ secrets.HOSTINGER_FTP_SERVER }}".Trim()
          $server = $server -replace '^ftps?://', ''
          $server = $server.Split('/')[0]
          if ([string]::IsNullOrWhiteSpace($server)) { throw "Invalid HOSTINGER_FTP_SERVER format" }
          $rawPort = "${{ secrets.HOSTINGER_FTP_PORT }}".Trim()
          if ([string]::IsNullOrWhiteSpace($rawPort)) { $rawPort = "21" }
          $parsedPort = 0
          if (-not [int]::TryParse($rawPort, [ref]$parsedPort)) { throw "Invalid HOSTINGER_FTP_PORT: $rawPort" }
          $port = $parsedPort
          $test = Test-NetConnection -ComputerName $server -Port $port -WarningAction SilentlyContinue
          if (-not $test.TcpTestSucceeded) { throw "Hostinger FTP endpoint not reachable ($server:$port)" }
          Write-Output "FTP endpoint reachable."

      - name: Deploy via FTPS to Hostinger
        id: deploy_ftps
        continue-on-error: true
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.HOSTINGER_FTP_SERVER }}
          username: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          port: ${{ secrets.HOSTINGER_FTP_PORT }}
          protocol: ftps
          local-dir: ./public_html/
          server-dir: /public_html/

      - name: Retry deploy via FTP
        if: steps.deploy_ftps.outcome == 'failure'
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.HOSTINGER_FTP_SERVER }}
          username: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          password: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          port: ${{ secrets.HOSTINGER_FTP_PORT }}
          protocol: ftp
          local-dir: ./public_html/
          server-dir: /public_html/
